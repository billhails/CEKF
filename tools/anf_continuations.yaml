# ANF Continuation Specifications
# Generated from analysis of fn/rewrite/normalize.fn and docs/ANF-REWRITE.md
#
# Each continuation represents a point where the ANF normalization algorithm
# needs to suspend and wait for a subexpression to be normalized.

config:
  name: anf_kont
  description: "Continuation scaffolding for ANF normalization"
  parserInfo: false
  currency: MinExp
  includes:
    - minlam.h
  limited_includes:
    - minlam_debug.h

primitives: !include ../src/primitives.yaml

external:
- !include ../src/minlam.yaml

continuations:
  normalizeTerm:
    key: term
    brief: "Continuation for normalizing a term"
    context: |
      (define (normalize-term e)
        (normalize e [λ (x) x]))
    free_vars: {}

  normalizeName:
    key: name
    brief: "Continuation for normalize-name"
    context: |
      (define (normalize-name e k)
        (normalize e [λ (x)
          (if (value? x)
              (k x)
              (let ((y (gensym)))
                   `(let (,y ,x) ,(k y))))]))
    free_vars:
      k: AnfKont

  normalizeIff:
    key: iff
    brief: "Continuation for if-expression test"
    context: |
      (match e
          ...
          (`(if ,e0 ,e1 ,e2)
              (normalize-name e0
                  [λ (test)
                      (k `(if ,test
                              ,(normalize-term e1)
                              ,(normalize-term e2)))])))
    free_vars:
      k: AnfKont
      e1: MinExp
      e2: MinExp

  normalizeApplyOuter:
    key: callOuter
    brief: "Outer continuation for function application"
    context: |
      (match e
          ...
          (`(,Fn . ,Ms)
              (normalize-name Fn
                  [λ (t)
                      (normalize-names Ms
                          (λ (ts) (k `(,t . ,ts))))]))))
    free_vars:
      Ms: MinExprList
      k: AnfKont

  normalizeApplyInner:
    key: callInner
    brief: "Inner continuation for function application"
    context: |
      (match e
          ...
          (`(,Fn . ,Ms)
              (normalize-name Fn
                  (λ (t)
                      (normalize-names Ms
                          [λ (ts) (k `(,t . ,ts))])))))
    free_vars:
      t: MinExp
      k: AnfKont

  normalizeNamesOuter:
    key: namesOuter
    brief: "Outer continuation for normalizing argument list"
    context: |
      (define (normalize-names Ms k)
          (if (null? Ms)
              (k '())
              (normalize-name (car Ms) [λ (t)
                  (normalize-names (cdr Ms) (λ (ts)
                      (k `(,t . ,ts))))]))))
    free_vars:
      Ms: MinExprList
      k: AnfKont

  normalizeNamesInner:
    key: namesInner
    brief: "Inner continuation for normalizing argument list"
    context: |
      (define (normalize-names Ms k)
          (if (null? Ms)
              (k '())
              (normalize-name (car Ms) (λ (t)
                  (normalize-names (cdr Ms) [λ (ts)
                      (k `(,t . ,ts))])]))))
    free_vars:
      t: MinExp
      k: AnfKont

  normalizeLetRec:
    key: letrec
    brief: "Continuation for letrec-expression bindings"
    context: |
      (match e
          ...
          (`(letrec ,bindings ,body)
              (normalize-bindings bindings
                  [λ (anfbindings)
                      `(letrec ,anfbindings
                                ,(normalize body k))])))
    free_vars:
      body: MinExp
      k: AnfKont

  normalizeBindingsOuter:
    key: bindingsOuter
    brief: "Outer continuation for normalizing letrec bindings"
    context: |
      (define (normalize-bindings bindings k)
        (match bindings
          ('()
             (k '()))
          (`((,x ,val) . ,rest)
              (normalize val
                  [λ (anfval)
                    (normalize-bindings rest
                      (λ (anfrest)
                          (k `((,x ,anfval) . ,anfrest))))]))))
    free_vars:
      x: HashSymbol
      rest: MinBindings
      k: AnfKont

  normalizeBindingsInner:
    key: bindingsInner
    brief: "Inner continuation for normalizing letrec bindings"
    context: |
      (define (normalize-bindings bindings k)
        (match bindings
          ('()
             (k '()))
          (`((,x ,val) . ,rest)
              (normalize val
                  (λ (anfval)
                    (normalize-bindings rest
                      [λ (anfrest)
                          (k `((,x ,anfval) . ,anfrest))])))))
    free_vars:
      x: HashSymbol
      anfVal: MinExp
      k: AnfKont

  normalizeMakeVec:
    key: makeVec
    brief: "Continuation for vector construction"
    context: |
      (match e
          ...
          (`(make-vec ,nArgs . ,Ms)
              (normalize-names Ms
                  [λ (ts) (k `(make-vec ,nArgs . ,ts))])))
    free_vars:
      k: AnfKont

  normalizeCond:
    key: cond
    brief: "Continuation for cond expression"
    context: |
      (match e
          ...
          (`(cond ,e0 ,cases)
              (normalize-name e0
                  [λ (t)
                    (k `(cond ,t ,(normalize-cases cases)))])))
    free_vars:
      cases: MinCondCases
      k: AnfKont

  normalizeMatch:
    key: match
    brief: "Continuation for match expression"
    context: |
      (match e
          ...
          (`(match-expr ,e0 ,cases)
              (normalize-name e0
                  [λ (t)
                      (k `(match-expr ,t
                                      ,(normalize-match-cases cases)))])))
    free_vars:
      cases: MinMatchList
      k: AnfKont

  normalizePrimappOuter:
    key: primOuter
    brief: "Outer continuation for primitive application"
    context: |
      (match e
          ...
          (`(primitive-apply ,type ,e1 ,e2)
              (normalize-name e1
                  [λ (anfE1)
                      (normalize-name e2
                          (λ (anfE2)
                              (k `(primitive-apply ,type ,anfE1 ,anfE2))))])))
    free_vars:
      type: int
      e2: MinExp
      k: AnfKont

  normalizePrimappInner:
    key: primInner
    brief: "Inner continuation for primitive application"
    context: |
      (match e
          ...
          (`(primitive-apply ,type ,e1 ,e2)
              (normalize-name e1
                  (λ (anfE1)
                      (normalize-name e2
                          [λ (anfE2)
                              (k `(primitive-apply ,type ,anfE1 ,anfE2))])))))
    free_vars:
      type: int
      anfE1: MinExp
      k: AnfKont

  normalizeCallCC:
    key: callCC
    brief: "Continuation for callCC expression"
    context: |
      (match e
          ...
          (`(callCC ,e0)
              (normalize-name e0
                  [λ (t0) (k `(callCC ,t0))])))
    free_vars:
      k: AnfKont