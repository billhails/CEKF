# ANF Continuation Specifications
# Generated from analysis of fn/rewrite/normalize.fn and docs/ANF-REWRITE.md
#
# Each continuation represents a point where the ANF normalization algorithm
# needs to suspend and wait for a subexpression to be normalized.

config:
  name: anf_kont
  description: "Continuation scaffolding for ANF normalization"
  parserInfo: false
  includes:
    - lambda.h
  limited_includes:
    - lambda_debug.h

primitives: !include ../src/primitives.yaml

external:
  LamExp:
    meta:
      brief: Data from lambda stage
      description: Lambda data passed through continuation maps.
    data:
      cname: "struct LamExp *"
      printFn: printLamExp
      markFn: markLamExp
      valued: true
  LamArgs:
    meta:
      brief: List of LamExp
      description: List of lambda expressions.
    data:
      cname: "struct LamArgs *"
      printFn: printLamArgs
      markFn: markLamArgs
      valued: true

continuations:
  normalizeTerm:
    key: term
    brief: "Continuation for normalizing a term"
    context: |
      (define (normalize-term e)
        (normalize e [λ (x) x]))
    free_vars: {}
    param:
      name: anfExpr
      type: LamExp

  normalizeName:
    key: name
    brief: "Continuation for normalize-name"
    context: |
      (define (normalize-name e k)
        (normalize e [λ (x)
          (if (value? x)
              (k x)
              (let ((y (gensym)))
                   `(let (,y ,x) ,(k y))))]))
    free_vars:
      k: AnfKont
    param:
      name: anfval
      type: LamExp

  normalizeLet:
    notimplemented: true
    key: let
    brief: "Continuation for let-expression value"
    context: |
      (match e
          ...
          (`(let ((,x ,val)) ,body)
              (normalize val
                  [λ (anfval)
                      `(let ((,x ,anfval))
                            ,(normalize body k))])))
    free_vars:
      x: HashSymbol
      body: LamExp
      k: AnfKont
    param:
      name: anfval
      type: LamExp

  normalizeIff:
    key: iff
    brief: "Continuation for if-expression test"
    context: |
      (match e
          ...
          (`(if ,e0 ,e1 ,e2)
              (normalize-name e0
                  [λ (test)
                      (k `(if ,test
                              ,(normalize-term e1)
                              ,(normalize-term e2)))])))
    free_vars:
      k: AnfKont
      e1: LamExp
      e2: LamExp
    param:
      name: anfE0
      type: LamExp

  normalizeApplyOuter:
    key: callOuter
    brief: "Outer continuation for function application"
    context: |
      (match e
          ...
          (`(,Fn . ,Ms)
              (normalize-name Fn
                  [λ (t)
                      (normalize-names Ms
                          (λ (ts) (k `(,t . ,ts))))]))))
    free_vars:
      Ms: LamArgs
      k: AnfKont
    param:
      name: anfFn
      type: LamExp

  normalizeApplyInner:
    key: callInner
    brief: "Inner continuation for function application"
    context: |
      (match e
          ...
          (`(,Fn . ,Ms)
              (normalize-name Fn
                  (λ (t)
                      (normalize-names Ms
                          [λ (ts) (k `(,t . ,ts))])))))
    free_vars:
      t: LamExp
      k: AnfKont
    param:
      name: anfArgs
      type: LamExp

  normalizeNamesOuter:
    key: namesOuter
    brief: "Outer continuation for normalizing argument list"
    context: |
      (define (normalize-names Ms k)
          (if (null? Ms)
              (k '())
              (normalize-name (car Ms) [λ (t)
                  (normalize-names (cdr Ms) (λ (ts)
                      (k `(,t . ,ts))))]))))
    free_vars:
      Ms: LamArgs
      k: AnfKont
    param:
      name: t
      type: LamExp

  normalizeNamesInner:
    key: namesInner
    brief: "Inner continuation for normalizing argument list"
    context: |
      (define (normalize-names Ms k)
          (if (null? Ms)
              (k '())
              (normalize-name (car Ms) (λ (t)
                  (normalize-names (cdr Ms) [λ (ts)
                      (k `(,t . ,ts))])]))))
    free_vars:
      t: LamExp
      k: AnfKont
    param:
      name: ts
      type: LamExp

  normalizeLetRec:
    key: letrec
    brief: "Continuation for letrec-expression bindings"
    context: |
      (match e
          ...
          (`(letrec ,bindings ,body)
              (normalize-bindings bindings
                  [λ (anfbindings)
                      `(letrec ,anfbindings
                                ,(normalize body k))])))
    free_vars:
      body: LamExp
      k: AnfKont
    param:
      name: anfBindings
      type: LamExp

  normalizeBindingsOuter:
    notimplemented: true
    key: bindingsOuter
    brief: "Outer continuation for normalizing letrec bindings"
    context: |
      (define (normalize-bindings bindings k)
        (match bindings
          ('()
             (k '()))
          (`((,x ,val) . ,rest)
              (normalize val
                  [λ (anfval)
                    (normalize-bindings rest
                      (λ (anfrest)
                          (k `((,x ,anfval) . ,anfrest))))]))))
    free_vars:
      x: HashSymbol
      rest: LamExp
      k: AnfKont
    param:
      name: anfVal
      type: LamExp

  normalizeBindingsInner:
    notimplemented: true
    key: bindingsInner
    brief: "Inner continuation for normalizing letrec bindings"
    context: |
      (define (normalize-bindings bindings k)
        (match bindings
          ('()
             (k '()))
          (`((,x ,val) . ,rest)
              (normalize val
                  (λ (anfval)
                    (normalize-bindings rest
                      [λ (anfrest)
                          (k `((,x ,anfval) . ,anfrest))])))))
    free_vars:
      x: HashSymbol
      anfVal: LamExp
      k: AnfKont
    param:
      name: anfRest
      type: LamExp

  normalizeConstruct:
    notimplemented: true
    key: construct
    brief: "Continuation for type constructor application"
    context: |
      (match e
          ...
          (`(construct ,name . ,Ms)
              (normalize-names Ms
                  [λ (ts) (k `(construct ,name . ,ts))])))
    free_vars:
      name: HashSymbol
      k: AnfKont
    param:
      name: anfArgs
      type: LamExp

  normalizeMakeTuple:
    notimplemented: true
    key: makeTuple
    brief: "Continuation for tuple construction"
    context: |
      (match e
          ...
          (`(make-tuple . ,Ms)
              (normalize-names Ms
                  [λ (ts) (k `(make-tuple . ,ts))])))
    free_vars:
      k: AnfKont
    param:
      name: anfElems
      type: LamExp

  normalizeMakeVec:
    notimplemented: true
    key: makeVec
    brief: "Continuation for vector construction"
    context: |
      (match e
          ...
          (`(make-vec ,nargs . ,Ms)
              (normalize-names Ms
                  [λ (ts) (k `(make-vec ,nargs . ,ts))])))
    free_vars:
      size: int
      k: AnfKont
    param:
      name: anfElems
      type: LamExp

  normalizeDeconstruct:
    notimplemented: true
    key: deconstruct
    brief: "Continuation for deconstruct operation"
    context: |
      (match e
          ...
          (`(deconstruct ,name ,index ,e0)
              (normalize-name e0
                  [λ (t) (k `(deconstruct ,name ,index ,t))])))
    free_vars:
      name: HashSymbol
      index: int
      k: AnfKont
    param:
      name: anfExpr
      type: LamExp

  normalizeCond:
    notimplemented: true
    key: cond
    brief: "Continuation for cond expression"
    context: |
      (match e
          ...
          (`(cond ,e0 ,cases)
              (normalize-name e0
                  [λ (t)
                      (k `(cond ,t
                                ,(normalize-cases cases)))])))
    free_vars:
      cases: LamExp
      k: AnfKont
    param:
      name: anfTest
      type: LamExp

  normalizeMatch:
    notimplemented: true
    key: match
    brief: "Continuation for match expression"
    context: |
      (match e
          ...
          (`(match-expr ,e0 ,cases)
              (normalize-name e0
                  [λ (t)
                      (k `(match-expr ,t
                                      ,(normalize-cases cases)))])))
    free_vars:
      cases: LamExp
      k: AnfKont
    param:
      name: anfExpr
      type: LamExp

  normalizePrimappOuter:
    notimplemented: true
    key: primOuter
    brief: "Outer continuation for primitive application"
    context: |
      (match e
          ...
          (`(primitive-apply ,op ,e0 ,e1)
              (normalize-name e0
                  [λ (anfE0)
                      (normalize-name e1
                          (λ (anfE1)
                              (k `(primitive-apply ,op ,anfE0 ,anfE1))))])))
    free_vars:
      op: HashSymbol
      e2: LamExp
      k: AnfKont
    param:
      name: anfE1
      type: LamExp

  normalizePrimappInner:
    notimplemented: true
    key: primInner
    brief: "Inner continuation for primitive application"
    context: |
      (match e
          ...
          (`(primitive-apply ,op ,e0 ,e1)
              (normalize-name e0
                  (λ (anfE0)
                      (normalize-name e1
                          [λ (anfE1)
                              (k `(primitive-apply ,op ,anfE0 ,anfE1))])))))
    free_vars:
      op: HashSymbol
      anfE1: LamExp
      k: AnfKont
    param:
      name: anfE2
      type: LamExp

  normalizePrint:
    notimplemented: true
    key: print
    brief: "Continuation for print expression"
    context: |
      (match e
          ...
          (`(print ,e0)
              (normalize-name e0
                  [λ (anfE0) (k `(print ,anfE0))])))
    free_vars:
      k: AnfKont
    param:
      name: anfExpr
      type: LamExp

  normalizeTypeof:
    notimplemented: true
    key: typeOf
    brief: "Continuation for typeof expression"
    context: |
      (match e
          ...
          (`(typeof ,e0)
              (normalize-name e0
                  [λ (anfE0) (k `(typeof ,anfE0))])))
    free_vars:
      k: AnfKont
    param:
      name: anfExpr
      type: LamExp

  normalizeTupleIndex:
    notimplemented: true
    key: tupleIndex
    brief: "Continuation for tuple indexing"
    context: |
      (match e
          ...
          (`(tuple-index ,size ,index ,e0)
              (normalize-name e0
                  [λ (t0) (k `(tuple-index ,size ,index ,t0))])))
    free_vars:
      size: int
      index: int
      k: AnfKont
    param:
      name: anfTuple
      type: LamExp

  normalizeTag:
    notimplemented: true
    key: tag
    brief: "Continuation for tag extraction"
    context: |
      (match e
          ...
          (`(tag ,e0)
              (normalize-name e0
                  [λ (t0) (k `(tag ,t0))])))
    free_vars:
      k: AnfKont
    param:
      name: anfExpr
      type: LamExp
