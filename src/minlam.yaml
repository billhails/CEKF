#
# CEKF - VM supporting amb
# Copyright (C) 2022-2024  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: minlam
    description: Minimal lambda calculus AST after desugaring
    parserInfo: true
    limited_includes:
    - bigint.h
    - tc.h
    - tc_debug.h
    - minlam_functions.h

structs:
    MinLam:
        meta:
            brief: A lambda expression
            description: >-
                If isMacro is true,
                all arguments are expected to be thunked (lazy).
        data:
            args: MinVarList
            exp: MinExp
            isMacro: bool=false

    MinVarList:
        meta:
            brief: Formal arguments to a lambda expression
        data:
            var: HashSymbol
            next: MinVarList

    MinPrimApp:
        meta:
            brief: A primitive operation application
        data:
            type: MinPrimOp
            exp1: MinExp
            exp2: MinExp

    MinSequence:
        meta:
            brief: A sequence of lambda expressions e.g. (begin ...)
        data:
            exp: MinExp
            next: MinSequence

    MinArgs:
        meta:
            brief: Actual arguments to a MinApply.
        data:
            exp: MinExp
            next: MinArgs

    MinApply:
        meta:
            brief: A function application.
        data:
            function: MinExp
            args: MinArgs

    MinLookUp:
        meta:
            brief: A lookUp in a nameSpace
            description: >-
                Represents the evaluation of an expression
                in a different nameSpace.
        data:
            nsId: int
            nsSymbol: HashSymbol
            exp: MinExp

    MinLookUpSymbol:
        meta:
            brief: A lookUp of a symbol (constructor) in a nameSpace.
        data:
            nsId: int
            nsSymbol: HashSymbol
            symbol: HashSymbol

    MinConstant:
        meta:
            brief: A constant type constructor with no arguments.
        data:
            name: HashSymbol # the name of the constructor
            tag: int         # the tag of the constructor

    MinDeconstruct:
        meta:
            brief: A deconstruction of a constructor
            description: >-
                Used to extract fields from a constructed value.
        data:
            name: HashSymbol # name of the constructor being deconstructed
            nsId: int        # nameSpace of the constructor being deconstructed
            vec: int         # offset of the field in the vector
            exp: MinExp      # expression being deconstructed

    MinTupleIndex:
        meta:
            brief: An index into a tuple
        data:
            vec: int         # offset of the field in the untagged tuple vector
            size: int        # size of the tuple
            exp: MinExp      # expression being accessed

    MinMakeVec:
        meta:
            brief: A vector constructor
            description: >-
                This structure represents the internal construction of a
                type instance (represented as a vector) from a list of arguments.
        data:
            nArgs: int
            args: MinArgs

    MinIff:
        meta:
            brief: An if-then-else expression
        data:
            condition: MinExp
            consequent: MinExp
            alternative: MinExp

    MinCond:
        meta:
            brief: A conditional expression with multiple cases.
            description: >-
                Used internally by the generated TPMC code, the cases can
                be either integers (matcing type constructors) or characters
                (matching literal characters). The type of the value must match
                the type of the cases.
        data:
            value: MinExp
            cases: MinCondCases

    MinIntCondCases:
        meta:
            brief: Integer conditional cases
            description: >-
                Used internally by the generated TPMC for matching type constructor ids.
        data:
            constant: MaybeBigInt
            body: MinExp
            next: MinIntCondCases

    MinCharCondCases:
        meta:
            brief: Character conditional cases
            description: >-
                Holds a list of character conditional cases
                generated by the TPMC for matching literal characters.
        data:
            constant: character
            body: MinExp
            next: MinCharCondCases

    MinMatch:
        meta:
            brief: An integer matching expression
            description: >-
                Matches an integer index against multiple lists of cases. Each list
                of cases is associated with a body expression to be executed on match.
                Again this is generated by the TPMC.
        data:
            index: MinExp
            cases: MinMatchList

    MinMatchList:
        meta:
            brief: A list of pattern matching cases
            description: >-
                One set of cases in a MinMatch.
        data:
            matches: MinIntList
            body: MinExp
            next: MinMatchList

    MinIntList:
        meta:
            brief: A list of integers
            description: >-
                The list of integers in a MinMatchList.
                Includes a namespace id and name (why?).
        data:
            item: int
            name: HashSymbol
            nsId: int
            next: MinIntList

    MinLetRec:
        meta:
            brief: A letrec expression
        data:
            bindings: MinBindings
            body: MinExp

    MinBindings:
        meta:
            brief: Bindings in a let or letrec expression
        data:
            var: HashSymbol
            val: MinExp
            next: MinBindings

    MinContext:
        meta:
            brief: A context for lambda expressions
        data:
            frame: MinInfoTable
            aliases: MinAliasTable
            macros: MinMacroSet
            parent: MinContext

    MinAmb:
        meta:
            brief: An amb expression
        data:
            left: MinExp
            right: MinExp

    MinTypeDefs:
        meta:
            brief: Type definitions in a lambda expression
            description: >-
                This structure holds type definitions.
                It is prepended to Each letrec and any
                typeDefs in the letrec are hoisted into this section.
        data:
            typeDefs: MinTypeDefList
            body: MinExp

    MinTypeDefList:
        meta:
            brief: A list of type definitions
            description: >-
                contained by a MinTypeDefs structure.
        data:
            typeDef: MinTypeDef
            next: MinTypeDefList

    MinTypeDef:
        meta:
            brief: A single type definition
        data:
            type: MinTypeSig # re-use
            constructors: MinTypeConstructorList

    MinTypeConstructorList:
        meta:
            brief: A list of type constructors forming the body of a typedef.
        data:
            constructor: MinTypeConstructor
            next: MinTypeConstructorList

    MinTypeSig:
        meta:
            brief: A type signature
            description: >-
                This structure represents a type signature that includes the
                name of the type and its argument type variables.
        data:
            name: HashSymbol
            args: MinTypeSigArgs

    MinTypeTags:
        meta:
            brief: Tags for a type constructor
            description: >-
                This structure holds tags that are associated with a type
                in the type constructor info metadata.
        data:
            tag: HashSymbol
            next: MinTypeTags

    MinTypeSigArgs:
        meta:
            brief: Argument type variables for a type signature
        data:
            name: HashSymbol
            next: MinTypeSigArgs

    MinTypeConstructor:
        meta:
            brief: A type constructor as part of a typedef.
        data:
            name: HashSymbol
            type: MinTypeSig
            args: MinTypeConstructorArgs

    MinTypeConstructorArgs:
        meta:
            brief: Formal arguments for a type constructor
        data:
            arg: MinTypeConstructorType
            next: MinTypeConstructorArgs

    MinTypeFunction:
        meta:
            brief: A type function as a formal argument to a type constructor
        data:
            name: MinLookUpOrSymbol
            args: MinTypeConstructorArgs

    MinTypeConstructorInfo:
        meta:
            brief: Information about a type constructor
        data:
            name: HashSymbol
            nsId: int
            type: MinTypeConstructor
            tags: MinTypeTags
            needsVec: bool # does this need to be a vector?
            arity: int # number of arguments to this constructor
            size: int # number of alternatives
            index: int # index into list of alternatives

    MinAlphaEnv:
        meta:
            brief: An environment for alpha conversion
        parserInfo: false
        data:
            alphaTable: MinAlphaTable
            next: MinAlphaEnv
            nameSpaces: MinAlphaEnvArray=NULL
enums:
    MinPrimOp:
        meta:
            brief: Primitive operations
        data:
            - ADD
            - SUB
            - MUL
            - DIV
            - MOD
            - POW
            - EQ
            - NE
            - GT
            - LT
            - GE
            - LE
            - CMP
            - VEC

unions:
    MinExp:
        meta:
            brief: A lambda expression
        data:
            amb: MinAmb
            apply: MinApply
            args: MinArgs # so that ANF normalize can be uniformly typed
            back: void_ptr
            bigInteger: MaybeBigInt
            bindings: MinBindings # so that ANF normalize can be uniformly typed
            callCC: MinExp
            character: character
            cond: MinCond
            constant: MinConstant
            constructor: MinTypeConstructorInfo
            deconstruct: MinDeconstruct
            env: void_ptr
            error: void_ptr
            iff: MinIff
            lam: MinLam
            letRec: MinLetRec
            lookUp: MinLookUp
            makeTuple: MinArgs
            makeVec: MinMakeVec
            match: MinMatch
            nameSpaces: MinNameSpaceArray
            prim: MinPrimApp
            sequence: MinSequence
            stdint: int
            tag: MinExp
            tupleIndex: MinTupleIndex
            typeDefs: MinTypeDefs
            var: HashSymbol

    MinLookUpOrSymbol:
        meta:
            brief: A lookUp or symbol in a nameSpace
            description: >-
                Represents either a lookUp of a symbol in a
                nameSpace or a symbol in the current nameSpace.
        data:
            symbol: HashSymbol
            lookUp: MinLookUpSymbol

    MinCondCases:
        meta:
            brief: Cases for a MinCond
        data:
            integers: MinIntCondCases
            characters: MinCharCondCases

    MinTypeConstructorType:
        meta:
            brief: A type constructor type
            description: >-
                Defines the different types of arguments that can
                be passed to a type constructor.
        data:
            integer: void_ptr
            character: void_ptr
            var: HashSymbol
            function: MinTypeFunction
            tuple: MinTypeConstructorArgs

    MinInfo:
        meta:
            brief: Information about a symbol
        data:
            typeConstructorInfo: MinTypeConstructorInfo
            nameSpaceInfo: MinContext
            nsId: int

hashes:
    MinMacroSet:
        meta:
            brief: the set of symbols that are currently defined as macros
            description: >-
                This table holds the symbols that are bound to macros in the
                current context.
        data: {}

    MinMacroArgsSet:
        meta:
            brief: the set of symbols that are currently defined as macro arguments
            description: >-
                This table holds the symbols that are bound to macro arguments
                in the current context (body of the macro).
        data: {}

    MinInfoTable:
        meta:
            brief: Map from symbols to information about them
            description: >-
                This table holds information about symbols in the current context.
        data:
            entries: MinInfo

    MinAliasTable:
        meta:
            brief: Map from symbols to their types in the body of a type constructor.
        data:
            entries: MinTypeConstructorType

    MinExpTable:
        meta:
            brief: Map from symbols to lambda expressions
            description: >-
                This table holds lambda expressions that are associated with
                symbols in the current context, used for macro arguments where
                the expressions are passed in unevaluated.
        data:
            entries: MinExp

    MinAlphaTable:
        meta:
            brief: Map from symbols to their substitutes
            description: >-
                Table for alpha conversion, mapping from original symbols
                to their unique replacements.
        data:
            entries: HashSymbol

arrays:
    MinNameSpaceArray:
        meta:
            brief: A list of nameSpaces
            description: >-
                This array holds the bodies of nameSpaces that are currently
                in scope.  The ubiquitous `ns_id` is an index into this array.
        data:
            entries: MinExp

    MinAlphaEnvArray:
        meta:
            brief: An array of alpha conversion environments
            description: >-
                This array holds the alpha conversion environments per-nameSpace,
                necessary for alpha-converting lookup expressions.
        data:
            entries: MinAlphaEnv

primitives: !include primitives.yaml

external:
    TcType:
        data:
            cname: "struct TcType *"
            printFn: printTcType
            markFn: markTcType
            valued: true
