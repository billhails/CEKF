#
# CEKF - VM supporting amb
# Copyright (C) 2022-2024  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: minlam
    description: Minimal lambda calculus AST after desugaring
    parserInfo: true
    limited_includes:
    - bigint.h
    - tc.h
    - tc_debug.h
    - minlam_functions.h

structs:
    MinLam:
        meta:
            brief: A lambda expression
        data:
            args: MinVarList
            exp: MinExp

    MinVarList:
        meta:
            brief: Formal arguments to a lambda expression
        data:
            var: HashSymbol
            next: MinVarList

    MinPrimApp:
        meta:
            brief: A primitive operation application
        data:
            type: MinPrimOp
            exp1: MinExp
            exp2: MinExp

    MinSequence:
        meta:
            brief: A sequence of lambda expressions e.g. (begin ...)
        data:
            exp: MinExp
            next: MinSequence

    MinArgs:
        meta:
            brief: Actual arguments to a MinApply.
        data:
            exp: MinExp
            next: MinArgs

    MinApply:
        meta:
            brief: A function application.
        data:
            function: MinExp
            args: MinArgs

    MinLookUp:
        meta:
            brief: A lookUp in a nameSpace
            description: >-
                Represents the evaluation of an expression
                in a different nameSpace.
        data:
            nsId: int
            nsSymbol: HashSymbol
            exp: MinExp

    MinMakeVec:
        meta:
            brief: A vector constructor
            description: >-
                This structure represents the internal construction of a
                type instance (represented as a vector) from a list of arguments.
        data:
            nArgs: int
            args: MinArgs

    MinIff:
        meta:
            brief: An if-then-else expression
        data:
            condition: MinExp
            consequent: MinExp
            alternative: MinExp

    MinCond:
        meta:
            brief: A conditional expression with multiple cases.
            description: >-
                Used internally by the generated TPMC code, the cases can
                be either integers (matcing type constructors) or characters
                (matching literal characters). The type of the value must match
                the type of the cases.
        data:
            value: MinExp
            cases: MinCondCases

    MinIntCondCases:
        meta:
            brief: Integer conditional cases
            description: >-
                Used internally by the generated TPMC for matching type constructor ids.
        data:
            constant: MaybeBigInt
            body: MinExp
            next: MinIntCondCases

    MinCharCondCases:
        meta:
            brief: Character conditional cases
            description: >-
                Holds a list of character conditional cases
                generated by the TPMC for matching literal characters.
        data:
            constant: character
            body: MinExp
            next: MinCharCondCases

    MinMatch:
        meta:
            brief: An integer matching expression
            description: >-
                Matches an integer index against multiple lists of cases. Each list
                of cases is associated with a body expression to be executed on match.
                Again this is generated by the TPMC.
        data:
            index: MinExp
            cases: MinMatchList

    MinMatchList:
        meta:
            brief: A list of pattern matching cases
            description: >-
                One set of cases in a MinMatch.
        data:
            matches: MinIntList
            body: MinExp
            next: MinMatchList

    MinIntList:
        meta:
            brief: A list of integers
            description: >-
                The list of integers in a MinMatchList.
                Includes a namespace id and name (why?).
        data:
            item: int
            name: HashSymbol
            nsId: int
            next: MinIntList

    MinLetRec:
        meta:
            brief: A letrec expression
        data:
            bindings: MinBindings
            body: MinExp

    MinBindings:
        meta:
            brief: Bindings in a letrec expression
        data:
            var: HashSymbol
            val: MinExp
            next: MinBindings

    MinAmb:
        meta:
            brief: An amb expression
        data:
            left: MinExp
            right: MinExp

    MinAlphaEnv:
        meta:
            brief: An environment for alpha conversion
        parserInfo: false
        data:
            alphaTable: MinAlphaTable
            next: MinAlphaEnv
            nameSpaces: MinAlphaEnvArray=NULL

enums:
    MinPrimOp:
        meta:
            brief: Primitive operations
        data:
            - ADD
            - SUB
            - MUL
            - DIV
            - MOD
            - POW
            - EQ
            - NE
            - GT
            - LT
            - GE
            - LE
            - CMP
            - VEC

unions:
    MinExp:
        meta:
            brief: An expression
        data:
            amb: MinAmb
            apply: MinApply
            args: MinArgs # so that ANF normalize can be uniformly typed
            back: void_ptr
            bigInteger: MaybeBigInt
            bindings: MinBindings # so that ANF normalize can be uniformly typed
            callCC: MinExp
            character: character
            cond: MinCond
            env: void_ptr
            error: void_ptr
            iff: MinIff
            lam: MinLam
            letRec: MinLetRec
            lookUp: MinLookUp
            makeVec: MinMakeVec
            match: MinMatch
            nameSpaces: MinNameSpaceArray
            prim: MinPrimApp
            sequence: MinSequence
            stdint: int
            var: HashSymbol

    MinCondCases:
        meta:
            brief: Cases for a MinCond
        data:
            integers: MinIntCondCases
            characters: MinCharCondCases

hashes:
    MinExpTable:
        meta:
            brief: Map from symbols to lambda expressions
            description: >-
                This table holds lambda expressions that are associated with
                symbols in the current context, used for macro arguments where
                the expressions are passed in unevaluated.
        data:
            entries: MinExp

    MinAlphaTable:
        meta:
            brief: Map from symbols to their replacements
            description: >-
                Table for alpha conversion, mapping from original symbols
                to their unique replacements.
        data:
            entries: HashSymbol

arrays:
    MinNameSpaceArray:
        meta:
            brief: A list of nameSpaces
            description: >-
                This array holds the bodies of nameSpaces that are currently
                in scope.  The ubiquitous `ns_id` is an index into this array.
        data:
            entries: MinExp

    MinAlphaEnvArray:
        meta:
            brief: An array of alpha conversion environments
            description: >-
                This array holds the alpha conversion environments per-nameSpace,
                necessary for alpha-converting lookup expressions.
        data:
            entries: MinAlphaEnv

primitives: !include primitives.yaml
