#
# CEKF - VM supporting amb
# Copyright (C) 2022-2026  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: minlam
    description: Minimal AST after desugaring
    parserInfo: true
    includes:
    - utils.h
    limited_includes:
    - bigint.h
    - tc.h
    - tc_debug.h
    - minlam_functions.h

structs:
    MinLam:
        meta:
            brief: A lambda expression
        data:
            args: SymbolList
            exp: MinExp

    MinExprList:
        meta:
            brief: A list of expressions
        data:
            exp: MinExp
            next: MinExprList

    MinPrimApp:
        meta:
            brief: A primitive operation application
        data:
            type: MinPrimOp
            exp1: MinExp
            exp2: MinExp

    MinApply:
        meta:
            brief: A function application.
        data:
            function: MinExp
            args: MinExprList
            isBuiltin: bool=false

    MinIff:
        meta:
            brief: An if-then-else expression
        data:
            condition: MinExp
            consequent: MinExp
            alternative: MinExp

    MinCond:
        meta:
            brief: A conditional expression with multiple cases.
            description: >-
                Used internally by the generated TPMC code, the cases can
                be either integers (matcing type constructor tags) or characters
                (matching literal characters). The type of the value must match
                the type of the cases.
        data:
            value: MinExp
            cases: MinCondCases

    MinIntCondCases:
        meta:
            brief: Integer conditional cases
        data:
            constant: MaybeBigInt
            body: MinExp
            next: MinIntCondCases

    MinCharCondCases:
        meta:
            brief: Character conditional cases
        data:
            constant: character
            body: MinExp
            next: MinCharCondCases

    MinMatch:
        meta:
            brief: An integer matching expression
            description: >-
                Matches an integer index against multiple lists of cases. Each list
                of cases is associated with a body expression to be executed on match.
                Again this is generated by the TPMC.
        data:
            index: MinExp
            cases: MinMatchList

    MinMatchList:
        meta:
            brief: A list of pattern matching cases
        data:
            matches: MinIntList
            body: MinExp
            next: MinMatchList

    MinIntList:
        meta:
            brief: A list of integers
        data:
            item: int
            next: MinIntList

    MinLetRec:
        meta:
            brief: A letrec expression
        data:
            bindings: MinBindings
            body: MinExp

    MinBindings:
        meta:
            brief: List of bindings in a letrec expression
        data:
            var: HashSymbol
            val: MinExp
            arity: int=-1 # populated by minlam_curry, used by minlam_uncurry
            next: MinBindings

    MinAmb:
        meta:
            brief: An amb expression
        data:
            left: MinExp
            right: MinExp

    MinAlphaEnv:
        meta:
            brief: An environment for alpha conversion
            parserInfo: false
        data:
            alphaTable: SymbolMap
            next: MinAlphaEnv
            nameSpaces: MinAlphaEnvArray=NULL

enums:
    MinPrimOp:
        meta:
            brief: Primitive operations
        data:
            - ADD
            - SUB
            - MUL
            - DIV
            - MOD
            - GCD
            - LCM
            - CANON
            - POW
            - EQ
            - NE
            - GT
            - LT
            - GE
            - LE
            - CMP
            - VEC

unions:
    MinExp:
        meta:
            brief: An expression
        data:
            amb: MinAmb
            apply: MinApply
            args: MinExprList # only for the alternative ANF normalize_2 path; must not appear in the real MinExp pipeline
            back: void_ptr
            bigInteger: MaybeBigInt
            bindings: MinBindings # so that ANF normalize can be uniformly typed
            callCC: MinExp
            character: character
            cond: MinCond
            iff: MinIff
            lam: MinLam
            letRec: MinLetRec
            makeVec: MinExprList
            match: MinMatch
            prim: MinPrimApp
            sequence: MinExprList
            stdint: int
            var: HashSymbol

    MinCondCases:
        meta:
            brief: Cases for a MinCond
        data:
            integers: MinIntCondCases
            characters: MinCharCondCases

hashes:
    MinExpTable:
        meta:
            brief: Map from symbols to lambda expressions
        data:
            entries: MinExp

arrays:
    MinAlphaEnvArray:
        meta:
            brief: An array of alpha conversion environments per-namespace.
            description: >-
                Used to alpha-convert lookUp expressions.
        data:
            entries: MinAlphaEnv

primitives: !include primitives.yaml

external:
- !include utils.yaml