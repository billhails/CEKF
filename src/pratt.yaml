#
# CEKF - VM supporting amb
# Copyright (C) 2022-2024  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: pratt
    description: Pratt Parser support
    parserInfo: false
    includes:
    - utils.h
    limited_includes:
    - file_id.h
    - ast_helper.h
    - ast_debug.h
    - pratt_functions.h
    - utils_debug.h

structs:
    # Scanner token parsing
    PrattTrie:
        meta:
            brief: A tree of tokens indexed by character.
            description: >-
                A Trie is a tree of tokens indexed by character. It is used to
                parse the input stream and build a parse tree. The root node
                has the first character, siblings are alternatives at the current level,
                and the children are indexed by subsequent characters of the token.
                Ordering of siblings ensures efficient search and insertion.
        data:
            character: character
            terminal: HashSymbol
            siblings: PrattTrie
            children: PrattTrie

    PrattBuffer:
        meta:
            brief: A buffer of wide characters.
            description: >-
                A buffer of wide characters that is both used during parsing
                and returned by the token parser (like yytext).
        data:
            data: PrattWVec
            start: wstring=NULL
            offset: int=0

    PrattBufList:
        meta:
            brief: A list of buffers.
            description: >-
                A list of buffers that are parsed in order. The first buffer
                is the most recent, and the last buffer is the oldest.
        data:
            lineNo: int
            fileName: HashSymbol
            buffer: PrattBuffer
            next: PrattBufList

    PrattToken:
        meta:
            brief: A token after parsing.
            description: >-
                A token after parsing. It contains the token type, the value,
                and the position in the input stream.
        data:
            type: HashSymbol
            fileName: HashSymbol
            lineNo: int
            value: PrattValue
            next: PrattToken

    PrattLexer:
        meta:
            brief: The current state of the scanner.
            description: >-
                The current state of the token scanner. It contains the current
                buffer, the current token, and the current position in the
                input stream.
        data:
            bufList: PrattBufList
            tokenHead: PrattToken=NULL
            tokenTail: PrattToken=NULL

    PrattParser:
        meta:
            brief: A parser for a specific scope.
            description: >-
                A parser for a specific scope. It contains the rules for parsing
                the input stream, the nameSpaces, and the lexer. It is intended
                to keep information about user defined operators imported from
                other nameSpaces.
        data:
            rules: PrattRecordTable
            nameSpaces: PrattNsIdTable
            lexer: PrattLexer=NULL
            trie: PrattTrie=NULL
            panicMode: bool=false
            isPreamble: bool=false
            next: PrattParser

    PrattRecord:
        meta:
            brief: A record in the Pratt parser table.
            description: >-
                A record in the Pratt parser table. It contains the operator
                information, precedence, and the implementation of the operator
                parser.
        data:
            symbol: HashSymbol
            prefix: PrattFixityConfig
            infix: PrattFixityConfig
            postfix: PrattFixityConfig

    PrattExportedOps:
        meta:
            brief: Exported operators for a nameSpace.
            description: >-
                Snapshot of exported operator records captured after a nameSpace is
                parsed for the first time. Intended to be cached and indexed by the
                nameSpace reference (nsRef) to support later imports without reparsing.
        data:
            exportedRules: PrattRecordTable

    PrattMixfixPattern:
        meta:
            brief: A mixfix operator pattern.
            description: >-
                A mixfix operator pattern that defines the structure of a mixfix
                operator. It contains the parts of the operator and their types
                and results from parsing a mixfix operator definition.
        data:
            keywords: PrattStrings
            arity: int
            associativity: PrattAssoc=PRATTASSOC_TYPE_NONE
            startsWithHole: bool
            endsWithHole: bool

vectors:
    PrattWVec:
        meta:
            brief: A fixed-length wchar_t string.
            description: >-
        data:
            entries: character

    PrattCVec:
        meta:
            brief: A fixed-length char string.
            description: >-
        data:
            entries: schar

enums:
    PrattAssoc:
        meta:
            brief: The set of associativity types for operators.
            description: >-
                The associativity of an operator determines how it is parsed
                in relation to other operators of the same precedence. It can
                be left associative, right associative, or non-associative.
                This is used to determine the order of operations during parsing.
        data:
            - LEFT
            - RIGHT
            - NONE

    PrattNumberState:
        meta:
            brief: The set of states for the number parser.
            description: >-
                The state of the number parser. It is used to parse numbers
                with a given radix. The parser can handle decimal, hexadecimal,
                and floating point numbers.
        data:
            - START
            - ZERO
            - HEX
            - DEC
            - FLOAT
            - END

    PrattStringState:
        meta:
            brief: The set of states for the string parser.
        data:
            - START
            - STR
            - ESC
            - ESCS
            - UNI
            - CHR
            - END

    PrattFixity:
        meta:
            brief: The set of fixity types for operators.
        data:
            - PREFIX
            - INFIX
            - POSTFIX

inline:
    structs:
        PrattFixityConfig:
            meta:
                brief: Configuration for an individual fixity (prefix/infix/postfix) of an operator.
            data:
                op: PrattParselet
                prec: int
                originalImpl: AstExpression=NULL
                hygienicFunc: HashSymbol=NULL
                isBareSymbol: bool=false
                export: bool=false
                pattern: PrattMixfixPattern=NULL
                importNsRef: int=-1
                importNsSymbol: HashSymbol=NULL

unions:
    PrattValue:
        meta:
            brief: The value of a token after parsing.
            description: >-
                The value of a token after parsing. It can be a string, number,
                character, or atom. This is used to represent the value of
                the token in the parse tree.
        data:
            string: WCharArray
            number: MaybeBigInt
            character: character
            atom: HashSymbol

hashes:
    PrattRecordTable:
        meta:
            brief: The Pratt parser table.
            description: >-
                The Pratt parser table is a hash table that maps tokens
                to their parsing rules. It is used to look up the
                parsing rules for operators during parsing. Each entry in the
                table contains the operator symbol, its precedence, and the
                implementations of the token parser for each fixity.
        data:
            entries: PrattRecord

    PrattNsIdTable:
        meta:
            brief: A hash table of nameSpace ids indexed by HashSymbol.
            description: >-
                A hash table that maps HashSymbol to integer values. It is used
                to store nameSpace ids.
        data:
            entries: int

arrays:
    PrattStrings:
        meta:
            brief: An array of Unicode strings.
            description: >-
                An array of Unicode strings that is used to hold
                multiple keywords for the PrattMixfixPattern structure.
        data:
            entries: WCharArray

    PrattParsers:
        meta:
            brief: A stack of Pratt parsers.
            description: >-
                A stack of Pratt parsers that are used to parse the input stream.
                Each parser is associated with a specific scope and contains
                the rules for parsing tokens in that scope, which can change due
                to user-defined operators or imported nameSpaces.
        data:
            entries: PrattParser

    PrattNsOpsArray:
        meta:
            brief: Array of exported operator sets indexed by nameSpace reference.
            description: >-
                Cache of exported operators per nameSpace. Each entry corresponds
                to a nameSpace reference (nsRef) and contains the set of operators
                that were explicitly exported by that nameSpace.
        data:
            entries: PrattExportedOps

primitives: !include primitives.yaml

external:
    AstExpression:
        data:
            cname: "struct AstExpression *"
            printFn: printAstExpression
            markFn: markAstExpression
            valued: true

    WCharArray:
        data:
            cname: "struct WCharArray *"
            printFn: printWCharArray
            markFn: markWCharArray
            newFn: newWCharArray
            compareFn: eqWCharArray
            valued: true