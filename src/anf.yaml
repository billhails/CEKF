#
# CEKF - VM supporting amb
# Copyright (C) 2022-2025  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: anf
    description: A-Normal Form (ANF) structures to be converted to bytecode.
    parserInfo: true
    includes:
    - utils.h
    limited_includes:
    - bigint.h
    - ast_helper.h
    - tc.h
    - tc_debug.h


structs:
    AnfEnv:
        meta:
            brief: ANF Compile Time Environment
            description: lookUp for the run-time locations of variables.
        data:
            isLocal: bool
            isNameSpace: bool = false
            isCapturing: bool = false
            nBindings: int = 0
            nsEnvs: AnfEnvArray = NULL
            table: IntMap
            next: AnfEnv

    AexpLam:
        meta:
            brief: ANF Aexp Lambda
            description: A lambda expression in ANF.
        data:
            nArgs: int
            letRecOffset: int
            args: AexpVarList
            exp: AnfExp

    AexpVarList:
        meta:
            brief: ANF Aexp Variable List
            description: A list of argument variables for a lambda.
        data:
            var: HashSymbol
            next: AexpVarList

    AexpAnnotatedVar:
        meta:
            brief: ANF Annotated Variable
            description: >-
                A variable annotated with its location in the environment.
        data:
            type: AexpAnnotatedVarType
            frame: int
            offset: int
            var: HashSymbol

    AexpPrimApp:
        meta:
            brief: ANF Aexp Primitive Application
            description: A primitive operation applied to two A-expressions.
        data:
            type: AexpPrimOp
            exp1: Aexp
            exp2: Aexp

    AexpList:
        meta:
            brief: ANF Aexp List
            description: A list of A-expressions.
        data:
            exp: Aexp
            next: AexpList

    AexpIntList:
        meta:
            brief: ANF Aexp Integer List
            description: A list of integers used in ANF.
        data:
            integer: int
            next: AexpIntList

    AexpMakeVec:
        meta:
            brief: ANF Aexp Make Vector
            description: A vector construction operation in ANF.
        data:
            nArgs: int
            args: AexpList

    AexpNameSpace:
        meta:
            brief: ANF Aexp NameSpace
            description: >-
                A nameSpace in ANF, containing the body of the nameSpace.
        data:
            nBindings: int = 0
            body: AnfExp

    AexpNameSpaces:
        meta:
            brief: ANF Aexp NameSpaces
            description: An array of nameSpaces in ANF.
        data:
            nameSpaces: AexpNameSpaceArray
            body: AnfExp

    CexpApply:
        meta:
            brief: ANF Cexp Apply
            description: A application of a function in ANF.
        data:
            function: Aexp
            nArgs: int
            args: AexpList

    CexpIf:
        meta:
            brief: ANF Cexp If
            description: A conditional expression in ANF.
        data:
            condition: Aexp
            consequent: AnfExp
            alternative: AnfExp

    CexpCond:
        meta:
            brief: ANF Cexp Conditional
            description: A conditional expression with multiple cases in ANF.
        data:
            condition: Aexp
            cases: CexpCondCases

    CexpIntCondCases:
        meta:
            brief: ANF Cexp Integer Conditional Cases
            description: >-
                Sub-class of CexpCondCases for big integer
                dispatch tables in ANF.
        data:
            option: MaybeBigInt
            body: AnfExp
            next: CexpIntCondCases

    CexpCharCondCases:
        meta:
            brief: ANF Cexp Character Conditional Cases
            description: >-
                Sub-class of CexpCondCases for UTF-32 character
                dispatch tables in ANF.
        data:
            option: character
            body: AnfExp
            next: CexpCharCondCases

    CexpMatch:
        meta:
            brief: ANF Cexp Match
            description: A match expression derived from a TPMC switch in ANF.
        data:
            condition: Aexp
            clauses: AnfMatchList

    CexpLetRec:
        meta:
            brief: ANF Cexp Let Rec
            description: A let-rec (recursive let) expression in ANF.
        data:
            nBindings: int
            bindings: AnfLetRecBindings
            body: AnfExp

    CexpAmb:
        meta:
            brief: ANF Cexp Amb
            description: An amb operation in ANF.
        data:
            exp1: AnfExp
            exp2: AnfExp

    CexpCut:
        meta:
            brief: ANF Cexp Cut
            description: A cut operation in ANF.
        data:
            exp: AnfExp

    AnfExpLet:
        data:
            var: HashSymbol
            val: AnfExp
            body: AnfExp

    AnfExpLookUp:
        data:
            nameSpace: index
            annotatedVar: AexpAnnotatedVar = NULL
            body: AnfExp

    AnfMatchList:
        meta:
            brief: ANF Match List
            description: A list of expressions each with multiple match cases
        data:
            matches: AexpIntList
            body: AnfExp
            next: AnfMatchList

    AnfLetRecBindings:
        meta:
            brief: ANF Let Rec Bindings
            description: A list of let-rec (recursive let) bindings in ANF.
        data:
            var: HashSymbol
            val: Aexp
            next: AnfLetRecBindings

unions:
    CexpCondCases:
        meta:
            brief: ANF Cexp Conditional Cases
            description: A union of conditional cases for CexpCond, either character or integer.
        data:
            charCases: CexpCharCondCases
            intCases: CexpIntCondCases

    Aexp:
        meta:
            brief: ANF Aexp
            description: A union of all A-expressions (atomic expressions) in ANF.
        data:
            lam: AexpLam
            var: HashSymbol
            annotatedVar: AexpAnnotatedVar
            bigInteger: MaybeBigInt
            littleInteger: int
            character: character
            prim: AexpPrimApp
            makeVec: AexpMakeVec
            nameSpaces: AexpNameSpaces

    Cexp:
        meta:
            brief: ANF Cexp
            description: A union of all C-expressions (complex expressions) in ANF.
        data:
            back: void_ptr
            error: void_ptr
            apply: CexpApply
            iff: CexpIf
            cond: CexpCond
            callCC: Aexp
            letRec: CexpLetRec
            amb: CexpAmb
            cut: CexpCut
            match: CexpMatch

    AnfExp:
        meta:
            brief: ANF Exp
            description: A union of all expression types (atomic or complex) in ANF.
        data:
            env: void_ptr
            done: void_ptr
            aexp: Aexp
            cexp: Cexp
            let: AnfExpLet
            lookUp: AnfExpLookUp

enums:
    AexpAnnotatedVarType:
        meta:
            brief: ANF Aexp Annotated Variable Type
            description: The type (i.e. location) of an annotated variable in ANF.
        data:
        - STACK
        - ENV

    AexpPrimOp:
        meta:
            brief: ANF Aexp Primitive Operation types.
            description: The type of all primitive operations in ANF.
        data:
        - ADD
        - SUB
        - MUL
        - DIV
        - GCD
        - LCM
        - CANON
        - POW
        - EQ
        - NE
        - LT
        - GT
        - LE
        - GE
        - VEC
        - MOD
        - CMP

arrays:
    AexpNameSpaceArray:
        meta:
            brief: ANF Aexp NameSpace Array
            description: An array of nameSpaces in ANF. 
        data:
            entries: AexpNameSpace

    AnfEnvArray:
        meta:
            brief: ANF Compile Time Environment Array
            description: An array of compile time environments in ANF.
        data:
            entries: AnfEnv

primitives: !include primitives.yaml

external:
- !include utils.yaml
- !include tc.yaml