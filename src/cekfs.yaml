#
# CEKF - VM supporting amb
# Copyright (C) 2022-2024  Bill Hails
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

config:
    name: cekfs
    description: The structures of the CEKFs machine
    parserInfo: false
    limited_includes:
        - builtins.h
        - builtins_debug.h
        - types.h
        - opaque.h

structs:
    CEKF:
        meta:
            brief: Control Environment Kontinuation Fail Stack
            description: The top-level CEKFs state machine
        data:
            C: control
            E: Env
            K: Kont
            F: Fail
            S: Stack
            B: ByteCodeArray
            L: LocationArray

    OverApplyFrame:
        meta:
            brief: OverApplyFrame
            description: An over-application frame for the CEKFs machine
        data:
            count: int
            index: int
            extras: Vec
            ready: bool

    Env:
        meta:
            brief: Environment
            description: The environment for the CEKFs machine
        data:
            S: Frame
            E: Env

    Kont:
        meta:
            brief: Kontinuation
            description: The continuation for the CEKFs machine
        data:
            C: control
            E: Env
            S: Stack
            K: Kont

    Clo:
        meta:
            brief: Closure
            description: A closure in the CEKFs machine
        data:
            pending: int
            C: control
            E: Env

    Fail:
        meta:
            brief: Fail
            description: The failure continuation for the CEKFs machine
        data:
            C: control
            E: Env
            K: Kont
            S: Stack
            F: Fail

    Location:
        meta:
            brief: Location
            description: A location in source code for reporting run-time errors
        data:
            loc: index
            lineno: int
            filename: string

inline:
    unions:
        Value:
            meta:
                brief: Value
                description: A flat value in the CEKFs machine (not a structure)
            data:
                none: void_ptr
                stdint: int
                bigint: BigInt
                rational: Vec
                rational_imag: Vec
                irrational: double
                stdint_imag: int
                bigint_imag: BigInt
                rational_imag: Vec
                irrational_imag: double
                complex: Vec
                character: character
                clo: Clo
                pclo: Clo
                kont: Kont
                vec: Vec
                builtIn: BuiltInImplementation
                nameSpace: Vec
                opaque: opaque

    arrays:
        ByteCodeArray:
            meta:
                brief: ByteCodeArray
                description: The bytecodes to be exeecuted.
            data:
                entries: byte

arrays:
    CharacterArray:
        meta:
            brief: CharacterArray
            description: An array of UTF-32, used for strings.
        data:
            entries: character

    ByteArray:
        meta:
            brief: ByteArray
            description: An array of bytes, used for i/o
        data:
            entries: byte

    Frame:
        meta:
            brief: Frame
            description: A frame for capturing closures
        data:
            entries: Value

    LocationArray:
        meta:
            brief: LocationArray
            description: An array of locations for reporting run-time errors.
        data:
            entries: Location

    OverApplyStack:
        meta:
            brief: OverApplyStack
            description: A stack of over-application frames
        data:
            entries: OverApplyFrame

vectors:
    Vec:
        meta:
            brief: Vec
            description: A vector of values representing complex arguments.
        data:
            entries: Value

stacks:
    Stack:
        meta:
            brief: Stack
            description: A simple stack
        data:
            entries: Value

enums:
    ByteCodes:
        meta:
            brief: ByteCodes
            description: The bytecode operations for the CEKFs machine
        data:
            - NONE
            - LAM
            - VAR
            - LVAR
            - PRIM_ADD
            - PRIM_SUB
            - PRIM_MUL
            - PRIM_DIV
            - PRIM_POW
            - PRIM_MOD
            - PRIM_EQ
            - PRIM_NE
            - PRIM_GT
            - PRIM_LT
            - PRIM_GE
            - PRIM_LE
            - PRIM_MAKEVEC
            - PRIM_VEC
            - MATCH
            - APPLY
            - IF
            - CHARCOND
            - INTCOND
            - LETREC
            - AMB
            - CUT
            - BACK
            - LET
            - CALLCC
            - STDINT
            - BIGINT
            - IRRATIONAL
            - CHAR
            - RETURN
            - JMP
            - PUSHN
            - DONE
            - ERROR
            - PRIM_CMP
            - STDINT_IMAG
            - BIGINT_IMAG
            - IRRATIONAL_IMAG
            - NS_START
            - NS_END
            - NS_FINISH
            - NS_PUSHSTACK
            - NS_PUSHENV
            - NS_POP

primitives: !include primitives.yaml

external:
    BuiltInImplementation:
        data:
            cname: "struct BuiltInImplementation *"
            printFn: printBuiltInImplementation
            markFn: markBuiltInImplementation
            valued: true
